# Trading Order 对接文档(简洁版)

**版本**: 2.0.0
**更新日期**: 2026-01-07

**文档说明**: 本文档面向C++订单网关和EMS撮合引擎的开发人员，介绍如何与Trading Order系统对接。

---

## 对接角色说明

### 1. C++订单网关（对接方）
- **角色**: 接收用户HTTP请求，通过TCP与Trading Order通信
- **TCP角色**: **TCP客户端**，主动连接Trading Order
- **职责**:
    - 接收用户的HTTP订单请求和撤单请求
    - 作为TCP客户端连接Trading Order（127.0.0.1:9900）
    - 发送ORDER_REQUEST到Trading Order
    - 接收Trading Order返回的ORDER_RESPONSE
    - 发送CANCEL_REQUEST到Trading Order
    - 接收Trading Order返回的CANCEL_RESPONSE

### 2. EMS撮合引擎（对接方）
- **角色**: 接收订单事件进行撮合，撮合完成后通知Trading Order
- **通信方式**: ZeroMQ双向通信（PUB-SUB模式）
- **职责**:
    - **接收端（SUB Socket）**: 绑定到5555端口，订阅"ORDER."主题，接收Trading Order的订单事件（ORDER_SUBMIT、ORDER_CANCEL）
    - **发送端（PUB Socket）**: 连接到Trading Order的5556端口，发送带"TRADE."主题前缀的成交通知
    - 实现订单撮合逻辑，目前可以做简单版本
      - 如果行情价格到了，就直接成交，
      - 两个用户订单相互成交

### 3. Trading Order系统（本系统）
- **TCP角色**: **TCP服务器**，监听9900端口
- **ZeroMQ角色**: 双向通信（PUB-SUB模式）
    - PUB Socket连接5555端口，发送带"ORDER."主题前缀的订单事件到EMS
    - SUB Socket绑定5556端口，订阅"TRADE."主题，接收EMS成交通知
- **数据存储**: Redis
- **交易对信息**: 从币安/欧易获取

---

## 系统架构

```
┌─────────┐  HTTP   ┌──────────────┐   TCP(客户端)   ┌──────────────────┐
│  用户   │────────>│  C++网关     │───────────────>│  Trading Order   │
│  User   │         │  Gateway     │<───────────────│  (TCP服务器:9900) │
└─────────┘         └──────────────┘   TCP响应       └────────┬─────────┘
                                                              │
                                         ZeroMQ(5555发送订单) │
                                                              ▼
                                                     ┌──────────────────┐
                                                     │   EMS撮合引擎    │
                                                     │  (PULL:5555)    │
                                                     │  (PUSH→5556)    │
                                                     └──────────────────┘
                                                              │
                                         ZeroMQ(5556接收成交) │
                                                              ▼
                                                     (回到Trading Order)
```

### 通信方式

| 连接 | 协议 | 端口/地址 | 通信双方 | 方向 | Topic | 用途 |
|-----|------|----------|---------|------|-------|------|
| TCP | Netty TCP | 9900 | 网关(客户端) ⇄ Trading Order(服务器) | 双向 | N/A | 订单请求、撤单请求、同步响应 |
| ZeroMQ通道1 | ZeroMQ PUB-SUB | 5555 | Trading Order(PUB) → EMS(SUB) | 单向 | ORDER. | 发送订单事件到EMS |
| ZeroMQ通道2 | ZeroMQ PUB-SUB | 5556 | EMS(PUB) → Trading Order(SUB) | 单向 | TRADE. | 接收EMS成交通知 |

---

## 1. TCP协议（网关对接）

### 1.1 连接说明

- **Trading Order**: TCP服务器，监听127.0.0.1:9900
- **C++网关**: TCP客户端，连接到Trading Order
- **协议**: Length-Prefix + JSON

### 1.2 传输协议

采用 **Length-Prefix** 协议，防止TCP粘包/拆包：

```
+----------------+-----------------------------------+
|  4 Bytes (Int) |      N Bytes (UTF-8 JSON)        |
|   消息长度     |          消息体                   |
+----------------+-----------------------------------+
```

- **消息长度**: 32位整型(Big Endian)，表示后续JSON字节数
- **消息体**: UTF-8编码的JSON字符串

### 1.3 消息结构(GatewayMessage)

```json
{
  "msgType": "消息类型",
  "msgId": "消息唯一ID",
  "timestamp": 1704528000000,
  "data": "{JSON格式的业务数据}"
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| msgType | String | 是 | 消息类型 |
| msgId | String | 是 | 消息唯一标识(建议UUID) |
| timestamp | Long | 是 | 消息时间戳(毫秒) |
| data | String | 是 | JSON格式的业务数据(字符串) |

### 1.4 消息类型

| 消息类型 | 方向 | 说明 | data字段内容 |
|---------|------|------|-------------|
| ORDER_REQUEST | 网关→Trading | 订单请求 | OrderRequest JSON(6个字段) |
| ORDER_RESPONSE | Trading→网关 | 订单响应 | OrderResponse JSON |
| CANCEL_REQUEST | 网关→Trading | 撤单请求 | CancelRequest JSON |
| CANCEL_RESPONSE | Trading→网关 | 撤单响应 | CancelResponse JSON |

### 1.5 消息详细定义

#### ORDER_REQUEST（下单请求）

网关发送给Trading Order的订单请求：

```json
{
  "symbol": "BTCUSDT",
  "orderType": "LIMIT",
  "side": "BUY",
  "price": "40000.00",
  "quantity": "1.5",
  "clientOrderId": "client_order_123"
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| symbol | String | 是 | 交易对(如BTCUSDT) |
| orderType | String | 是 | LIMIT(限价)/MARKET(市价) |
| side | String | 是 | BUY(买入)/SELL(卖出) |
| price | String | 否 | 价格(市价单可不传，限价单必填) |
| quantity | String | 是 | 数量 |
| clientOrderId | String | 否 | 客户端订单ID(可选) |

**完整TCP消息示例**:
```json
{
  "msgType": "ORDER_REQUEST",
  "msgId": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": 1704528000000,
  "data": "{\"symbol\":\"BTCUSDT\",\"orderType\":\"LIMIT\",\"side\":\"BUY\",\"price\":\"40000.00\",\"quantity\":\"1.5\",\"clientOrderId\":\"client_order_123\"}"
}
```

#### ORDER_RESPONSE（下单响应）

Trading Order返回给网关的响应：

```json
{
  "orderId": "ORD1704528000000_abc123",
  "status": "SUBMITTED",
  "code": 0,
  "message": "订单已提交"
}
```

| 字段 | 类型 | 说明 |
|-----|------|------|
| orderId | String | 订单ID（Trading Order生成） |
| status | String | 订单状态：SUBMITTED(已提交)/REJECTED(已拒绝) |
| code | Integer | 响应码，0表示成功，非0表示失败 |
| message | String | 响应消息 |

**完整TCP消息示例**:
```json
{
  "msgType": "ORDER_RESPONSE",
  "msgId": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": 1704528100000,
  "data": "{\"orderId\":\"ORD1704528000000_abc123\",\"status\":\"SUBMITTED\",\"code\":0,\"message\":\"订单已提交\"}"
}
```

#### CANCEL_REQUEST（撤单请求）

网关发送给Trading Order的撤单请求：

```json
{
  "orderId": "ORD1704528000000_abc123",
  "userId": "user001"
}
```

**完整TCP消息示例**:
```json
{
  "msgType": "CANCEL_REQUEST",
  "msgId": "660e8400-e29b-41d4-a716-446655440001",
  "timestamp": 1704528200000,
  "data": "{\"orderId\":\"ORD1704528000000_abc123\",\"userId\":\"user001\"}"
}
```

#### CANCEL_RESPONSE（撤单响应）

Trading Order返回给网关的撤单响应：

```json
{
  "orderId": "ORD1704528000000_abc123",
  "status": "CANCELED",
  "code": 0,
  "message": "撤单成功"
}
```

**完整TCP消息示例**:
```json
{
  "msgType": "CANCEL_RESPONSE",
  "msgId": "660e8400-e29b-41d4-a716-446655440001",
  "timestamp": 1704528300000,
  "data": "{\"orderId\":\"ORD1704528000000_abc123\",\"status\":\"CANCELED\",\"code\":0,\"message\":\"撤单成功\"}"
}
```

---

## 2. ZeroMQ协议（EMS对接）

### 2.1 协议概述

Trading Order与EMS之间通过两个ZeroMQ通道进行双向通信（PUB-SUB模式）：

**通道1：Trading Order → EMS（订单事件）**
- **Trading Order端**: PUB Socket，连接到tcp://127.0.0.1:5555
- **EMS端**: SUB Socket，绑定到tcp://*:5555，订阅"ORDER."主题
- **消息格式**: "ORDER." + EmsMessage JSON
- **用途**: Trading Order推送订单事件(ORDER_SUBMIT、ORDER_CANCEL)到EMS

**通道2：EMS → Trading Order（成交通知）**
- **EMS端**: PUB Socket，连接到tcp://127.0.0.1:5556
- **Trading Order端**: SUB Socket，绑定到tcp://*:5556，订阅"TRADE."主题
- **消息格式**: "TRADE." + Trade JSON
- **用途**: EMS推送成交通知(Trade对象)到Trading Order

### 2.2 通道1：订单事件消息结构(EmsMessage)

Trading Order发送给EMS：

```json
{
  "eventType": "事件类型",
  "orderId": "ORD1704528000000_abc123",
  "timestamp": 1704528000000,
  "data": "{JSON格式的详细数据}"
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| eventType | String | 是 | 事件类型：ORDER_SUBMIT、ORDER_CANCEL |
| orderId | String | 是 | 关联订单ID |
| timestamp | Long | 是 | 事件时间戳(毫秒) |
| data | String | 是 | JSON格式的详细数据 |

### 2.3 订单事件类型

| 事件类型 | 触发时机 | 说明 | data字段内容 |
|---------|---------|------|-------------|
| ORDER_SUBMIT | 订单提交成功 | 通知EMS新订单已提交 | Order对象JSON |
| ORDER_CANCEL | 订单撤销请求 | 通知EMS撤销订单 | CancelRequest JSON |

### 2.4 ORDER_SUBMIT（订单提交事件）

Trading Order发送给EMS的订单提交事件：

**完整ZeroMQ消息示例**（带"ORDER."主题前缀）:
```
ORDER.{"eventType":"ORDER_SUBMIT","orderId":"ORD1704528000000_abc123","timestamp":1704528000000,"data":"{\"orderId\":\"ORD1704528000000_abc123\",\"userId\":\"user001\",\"symbol\":\"BTCUSDT\",\"orderType\":\"LIMIT\",\"side\":\"BUY\",\"price\":\"40000.00\",\"quantity\":\"1.5\",\"filledQty\":\"0\",\"avgPrice\":\"0\",\"status\":\"SUBMITTED\",\"createTime\":1704528000000,\"updateTime\":1704528000000,\"clientOrderId\":\"client_order_123\"}"}
```

**EmsMessage JSON结构**:
```json
{
  "eventType": "ORDER_SUBMIT",
  "orderId": "ORD1704528000000_abc123",
  "timestamp": 1704528000000,
  "data": "{\"orderId\":\"ORD1704528000000_abc123\",\"userId\":\"user001\",\"symbol\":\"BTCUSDT\",\"orderType\":\"LIMIT\",\"side\":\"BUY\",\"price\":\"40000.00\",\"quantity\":\"1.5\",\"filledQty\":\"0\",\"avgPrice\":\"0\",\"status\":\"SUBMITTED\",\"createTime\":1704528000000,\"updateTime\":1704528000000,\"clientOrderId\":\"client_order_123\"}"
}
```

**data字段中的Order对象包含**:
- orderId: 订单ID
- userId: 用户ID
- symbol: 交易对
- orderType: LIMIT/MARKET
- side: BUY/SELL
- price: 价格
- quantity: 数量
- filledQty: 已成交数量(初始为"0")
- avgPrice: 平均成交价(初始为"0")
- status: 订单状态(SUBMITTED)
- createTime: 创建时间
- updateTime: 更新时间
- clientOrderId: 客户端订单ID(可选)

### 2.5 ORDER_CANCEL（订单撤销事件）

Trading Order发送给EMS的撤单事件：

**完整ZeroMQ消息示例**（带"ORDER."主题前缀）:
```
ORDER.{"eventType":"ORDER_CANCEL","orderId":"ORD1704528000000_abc123","timestamp":1704528100000,"data":"{\"orderId\":\"ORD1704528000000_abc123\",\"userId\":\"user001\"}"}
```

**EmsMessage JSON结构**:
```json
{
  "eventType": "ORDER_CANCEL",
  "orderId": "ORD1704528000000_abc123",
  "timestamp": 1704528100000,
  "data": "{\"orderId\":\"ORD1704528000000_abc123\",\"userId\":\"user001\"}"
}
```

### 2.6 通道2：成交通知消息结构(Trade)

**重要说明**:
- EMS撮合成功后，发送Trade对象JSON到Trading Order
- **消息格式**: `"TRADE." + Trade JSON`（topic前缀 + Trade对象）
- 不使用EmsMessage包装，直接在topic后拼接Trade对象
- 一笔成交涉及买卖双方，EMS应推送两条消息(分别通知买方和卖方对应的订单)

**完整ZeroMQ消息格式示例**（带"TRADE."主题前缀）:
```
TRADE.{"tradeId":"TRD1704528100000_xyz789","orderId":"ORD1704528000000_abc123",...}
```

**Trade JSON结构**:

```json
{
  "tradeId": "TRD1704528100000_xyz789",
  "orderId": "ORD1704528000000_abc123",
  "counterOrderId": "ORD1704528000000_def456",
  "userId": "user001",
  "symbol": "BTCUSDT",
  "price": "40000.00",
  "quantity": "1.5",
  "fee": "0.0015",
  "feeAsset": "BTC",
  "tradeTime": 1704528100000,
  "isMaker": false
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| tradeId | String | 是 | 成交ID(买卖双方使用同一个tradeId) |
| orderId | String | 是 | 关联订单ID(当前用户的订单) |
| counterOrderId | String | 否 | 对手订单ID(可选) |
| userId | String | 是 | 用户ID |
| symbol | String | 是 | 交易对 |
| price | String | 是 | 成交价格 |
| quantity | String | 是 | 成交数量 |
| fee | String | 是 | 手续费 |
| feeAsset | String | 是 | 手续费币种 |
| tradeTime | Long | 是 | 成交时间戳(毫秒) |
| isMaker | Boolean | 是 | 是否为Maker(挂单方) |

**双边成交通知示例**:

买单ORD001与卖单ORD002撮合成交，EMS推送两条Trade消息到Trading Order(5556端口)：

**通知买方**:
```json
{
  "tradeId": "TRD1704528100000_xyz789",
  "orderId": "ORD001",
  "counterOrderId": "ORD002",
  "userId": "buyer_user_001",
  "symbol": "BTCUSDT",
  "price": "40000.00",
  "quantity": "1.5",
  "fee": "0.0015",
  "feeAsset": "BTC",
  "tradeTime": 1704528100000,
  "isMaker": false
}
```

**通知卖方**:
```json
{
  "tradeId": "TRD1704528100000_xyz789",
  "orderId": "ORD002",
  "counterOrderId": "ORD001",
  "userId": "seller_user_002",
  "symbol": "BTCUSDT",
  "price": "40000.00",
  "quantity": "1.5",
  "fee": "60",
  "feeAsset": "USDT",
  "tradeTime": 1704528100000,
  "isMaker": true
}
```

---

## 3. 交互流程

### 3.1 完整下单流程

```
 用户               C++网关            Trading Order              EMS系统
  │                    │                      │                       │
  │ 1. HTTP下单        │                      │                       │
  │───────────────────>│                      │                       │
  │                    │ 2. ORDER_REQUEST(TCP)│                       │
  │                    │─────────────────────>│                       │
  │                    │                      │                       │
  │                    │                      │ 3. ORDER_SUBMIT(ZMQ)  │
  │                    │                      │──────────────────────>│
  │                    │                      │                       │
  │                    │ 4. ORDER_RESPONSE(TCP)                      │
  │                    │<─────────────────────│                       │
  │                    │                      │                       │
  │ 5. HTTP响应        │                      │                       │
  │<───────────────────│                      │                       │
  │                    │                      │                       │
  │                    │                      │ (EMS进行撮合)         │
  │                    │                      │                       │
  │                    │                      │ 6. Trade(ZMQ:5556)    │
  │                    │                      │<──────────────────────│
  │                    │                      │                       │
  │                    │                      │ 7. 更新订单状态、资产  │
  │                    │                      │                       │
```

**流程说明**:

1. 用户发送HTTP下单请求到C++网关
2. C++网关作为TCP客户端，发送ORDER_REQUEST到Trading Order（9900端口）
3. Trading Order通过ZeroMQ发送ORDER_SUBMIT事件到EMS（5555端口）
4. Trading Order立即返回ORDER_RESPONSE给C++网关
5. C++网关返回HTTP响应给用户
6. EMS撮合成功后，通过ZeroMQ发送Trade对象到Trading Order（5556端口）
7. Trading Order接收Trade后，更新订单状态和用户资产

### 3.2 撤单流程

```
 用户               C++网关            Trading Order              EMS系统
  │                    │                      │                       │
  │ 1. HTTP撤单        │                      │                       │
  │───────────────────>│                      │                       │
  │                    │ 2. CANCEL_REQUEST(TCP)                      │
  │                    │─────────────────────>│                       │
  │                    │                      │                       │
  │                    │                      │ 3. ORDER_CANCEL(ZMQ)  │
  │                    │                      │──────────────────────>│
  │                    │                      │                       │
  │                    │ 4. CANCEL_RESPONSE(TCP)                     │
  │                    │<─────────────────────│                       │
  │                    │                      │                       │
  │ 5. HTTP响应        │                      │                       │
  │<───────────────────│                      │                       │
  │                    │                      │                       │
```

---

## 4. 订单状态

| 状态 | 说明 | 流转条件 |
|-----|------|---------|
| PENDING | 待提交 | 初始状态 |
| SUBMITTED | 已提交 | Trading Order接收订单 |
| PARTIAL_FILLED | 部分成交 | 0 < filledQty < quantity |
| FILLED | 完全成交 | filledQty = quantity |
| CANCELED | 已撤销 | 用户撤单或系统撤单 |
| REJECTED | 已拒绝 | Trading Order拒绝订单 |

**状态流转图**:

```
PENDING → SUBMITTED → PARTIAL_FILLED → FILLED
            ↓              ↓
         REJECTED      CANCELED
```

---

## 5. 错误码

| 错误码 | 说明 | 处理建议 |
|-------|------|---------|
| 0 | 成功 | 正常处理 |
| 1001 | 订单不存在 | 检查订单ID |
| 1002 | 订单状态不允许操作 | 检查订单状态 |
| 1003 | 余额不足 | 检查账户余额 |
| 1004 | 交易对不存在 | 检查交易对配置 |
| 1005 | 参数错误 | 检查请求参数 |
| 9999 | 系统错误 | 联系技术支持 |

---

**文档结束**
